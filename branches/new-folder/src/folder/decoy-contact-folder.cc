#include "decoy-contact-folder.hh"
#include "protein.hh"
#include <cmath>


void DecoyContactStructure::read(ifstream& fin) {
	
}


DecoyContactFolder::DecoyContactFolder(int length, double m_log_num_confs, vector<DecoyContactStructure*>& structs) {
	m_length = length;
	m_structures = structs;
	m_log_num_conformations = m_log_num_confs;
	m_num_folded = 0;
}

FoldInfo DecoyContactFolder::foldProtein(Protein& p) {
	double kT = 0.6;
	double minG = 1e50;
	int minIndex = 0;
	double Z = 0;
	double dG;

	double sumG = 0.0;
	double sumsqG = 0.0;

	for ( unsigned int sid = 0; sid < m_structures.size(); sid++) {
		double G = 0;

		// calculate binding energy of this fold
		const vector<Contact> &pair_list = m_structures[sid]->getContacts();
		vector<Contact>::const_iterator it=pair_list.begin();
		for ( ; it!=pair_list.end(); it++ )	{
			int ind1 = (*it).first-1;
			int ind2 = (*it).second-1;
			int aa1 = p[ind1];
			int aa2 = p[ind1];
			double contact_G = contactEnergies[aa1][aa2];
			G += contact_G;

			//cout << "(" << (*it).first << ", " << (*it).second << ") -> " << GeneticCodeUtil::residues[p[(*it).first-1]] 
			//	 << ":" << GeneticCodeUtil::residues[p[(*it).second-1]] << " " << contact_G << " " << G << endl;
		}
		// check if binding energy is lower than any previously calculated one
		if ( G < minG )
		{
			minG = G;
			minIndex = sid;
		}
		// add energy to partition sum
		sumG += G;
		sumsqG += G*G;
	}

	unsigned int num_confs = m_structures.size();
	double mean_G = sumG/num_confs;
	double var_G = (sumsqG - (sumG*sumG)/num_confs)/(num_confs-1.0);
	// calculate free energy of folding
	dG = minG + (var_G - 2*kT*mean_G)/(2.0*kT) + kT * m_log_num_conformations;

	//cout <<  Z << " " << exp(-minE/kT) << " " << G << endl;
	//cout << "Folding energy: " << minE << endl;
	//cout << "Folding free energy: " << G << endl;

	// increment folded count
	m_num_folded += 1;

	return FoldInfo(dG, minIndex);
}


// Contact energies according to Miyazawa and Jernigan, Estimation of
// effective interresidue contact energies from protein crystal
// structures: Quasi-chemical approximation. Macromolecules 18:534-552
// (1985).
//Table V, values e_{ij}.
const double DecoyContactFolder::contactEnergies[20][20] =
	{
		// CYS
		{ -5.44, -5.05, -5.63, -5.03, -5.03, -4.46, -4.76, -3.89, -3.38, -3.16, -2.88, -2.86, -2.73, -2.59, -2.08, -2.66, -3.63, -2.70, -1.54, -2.92 },
		// MET
		{ -5.05, -6.06, -6.68, -6.33, -6.01, -5.52, -6.37, -4.92, -3.99, -3.75, -3.73, -3.55, -3.17, -3.50, -3.19, -2.90, -3.31, -3.49, -3.11, -4.11 },
		// PHE
		{ -5.63, -6.68, -6.85, -6.39, -6.26, -5.75, -6.02, -4.95, -4.36, -3.72, -3.76, -3.56, -3.30, -3.55, -3.51, -3.31, -4.61, -3.54, -2.83, -3.73 },
		// ILE
		{ -5.03, -6.33, -6.39, -6.22, -6.17, -5.58, -5.64, -4.63, -4.41, -3.65, -3.74, -3.43, -3.22, -2.99, -3.23, -2.91, -3.76, -3.33, -2.70, -3.47 },
		// LEU
		{ -5.03, -6.01, -6.26, -6.17, -5.79, -5.38, -5.50, -4.26, -3.96, -3.43, -3.43, -3.16, -3.09, -2.99, -2.91, -2.59, -3.84, -3.15, -2.63, -3.06 },
		// VAL
		{ -4.46, -5.52, -5.75, -5.58, -5.38, -4.94, -5.05, -4.05, -3.62, -3.06, -2.95, -2.79, -2.67, -2.36, -2.56, -2.25, -3.38, -2.78, -1.95, -2.96 },
		// TRP
		{ -4.76, -6.37, -6.02, -5.64, -5.50, -5.05, -5.42, -4.44, -3.93, -3.37, -3.31, -2.95, -3.16, -3.11, -2.94, -2.91, -4.02, -3.56, -2.49, -3.66 },
		// TYR
		{ -3.89, -4.92, -4.95, -4.63, -4.26, -4.05, -4.44, -3.55, -2.85, -2.50, -2.48, -2.30, -2.53, -2.47, -2.42, -2.25, -3.33, -2.75, -2.01, -2.80 },
		// ALA
		{ -3.38, -3.99, -4.36, -4.41, -3.96, -3.62, -3.93, -2.85, -2.51, -2.15, -2.15, -1.89, -1.70, -1.44, -1.51, -1.57, -2.09, -1.50, -1.10, -1.81 },
		// GLY
		{ -3.16, -3.75, -3.72, -3.65, -3.43, -3.06, -3.37, -2.50, -2.15, -2.17, -2.03, -1.70, -1.54, -1.56, -1.22, -1.62, -1.94, -1.68, -0.84, -1.72 },
		// THR
		{ -2.88, -3.73, -3.76, -3.74, -3.43, -2.95, -3.31, -2.48, -2.15, -2.03, -1.72, -1.59, -1.59, -1.51, -1.45, -1.66, -2.31, -1.97, -1.02, -1.66 },
		// SER
		{ -2.86, -3.55, -3.56, -3.43, -3.16, -2.79, -2.95, -2.30, -1.89, -1.70, -1.59, -1.48, -1.37, -1.31, -1.48, -1.46, -1.94, -1.22, -0.83, -1.35 },
		// GLN
		{ -2.73, -3.17, -3.30, -3.22, -3.09, -2.67, -3.16, -2.53, -1.70, -1.54, -1.59, -1.37, -0.89, -1.36, -1.33, -1.26, -1.85, -1.85, -1.02, -1.73 },
		// ASN
		{ -2.59, -3.50, -3.55, -2.99, -2.99, -2.36, -3.11, -2.47, -1.44, -1.56, -1.51, -1.31, -1.36, -1.59, -1.43, -1.33, -2.01, -1.41, -0.91, -1.43 },
		// GLU
		{ -2.08, -3.19, -3.51, -3.23, -2.91, -2.56, -2.94, -2.42, -1.51, -1.22, -1.45, -1.48, -1.33, -1.43, -1.18, -1.23, -2.27, -2.07, -1.60, -1.40 },
		// ASP
		{ -2.66, -2.90, -3.31, -2.91, -2.59, -2.25, -2.91, -2.25, -1.57, -1.62, -1.66, -1.46, -1.26, -1.33, -1.23, -0.96, -2.14, -1.98, -1.32, -1.19 },
		// HIS
		{ -3.63, -3.31, -4.61, -3.76, -3.84, -3.38, -4.02, -3.33, -2.09, -1.94, -2.31, -1.94, -1.85, -2.01, -2.27, -2.14, -2.78, -2.12, -1.09, -2.17 },
		// ARG
		{ -2.70, -3.49, -3.54, -3.33, -3.15, -2.78, -3.56, -2.75, -1.50, -1.68, -1.97, -1.22, -1.85, -1.41, -2.07, -1.98, -2.12, -1.39, -0.06, -1.85 },
		// LYS
		{ -1.54, -3.11, -2.83, -2.70, -2.63, -1.95, -2.49, -2.01, -1.10, -0.84, -1.02, -0.83, -1.02, -0.91, -1.60, -1.32, -1.09, -0.06,  0.13, -0.67 },
		// PRO
		{ -2.92, -4.11, -3.73, -3.47, -3.06, -2.96, -3.66, -2.80, -1.81, -1.72, -1.66, -1.35, -1.73, -1.43, -1.40, -1.19, -2.17, -1.85, -0.67, -1.18 }
	};

	/*
// Table VI, values e_{ij}+e_{rr}-e_{ir}-e_{jr}
const double DecoyContactFolder::contactEnergies[20][20] =
      {
	      // CYS
	      { -1.06,  0.19, -0.23,  0.16, -0.08,  0.06,  0.08,  0.04,  0.00, -0.08,  0.19, -0.02,  0.05,  0.13,  0.69,  0.03, -0.19,  0.24,  0.71,  0.00 },
	      // MET
	      {  0.19,  0.04, -0.42, -0.28, -0.20, -0.14, -0.67, -0.13,  0.25,  0.19,  0.19,  0.14,  0.46,  0.08,  0.44,  0.65,  0.99,  0.31,  0.00, -0.34 },
	      // PHE
	      { -0.23, -0.42, -0.44, -0.19, -0.30, -0.22, -0.16,  0.00,  0.03,  0.38,  0.31,  0.29,  0.49,  0.18,  0.27,  0.39, -0.16,  0.41,  0.44,  0.20 },
	      // ILE
	      {  0.16, -0.28, -0.19, -0.22, -0.41, -0.25,  0.02,  0.11, -0.22,  0.25,  0.14,  0.21,  0.36,  0.53,  0.35,  0.59,  0.49,  0.42,  0.36,  0.25 },
	      // LEU
	      { -0.08, -0.20, -0.30, -0.41, -0.27, -0.29, -0.09,  0.24, -0.01,  0.23,  0.20,  0.25,  0.26,  0.30,  0.43,  0.67,  0.16,  0.35,  0.19,  0.42 },
	      // VAL
	      {  0.06, -0.14, -0.22, -0.25, -0.29, -0.29, -0.07,  0.02, -0.10,  0.16,  0.25,  0.18,  0.24,  0.50,  0.34,  0.58,  0.19,  0.30,  0.44,  0.09 },
	      // TRP
	      {  0.08, -0.67, -0.16,  0.02, -0.09, -0.07, -0.12, -0.04, -0.09,  0.18,  0.22,  0.34,  0.08,  0.06,  0.29,  0.24, -0.12, -0.16,  0.22, -0.28 },
	      // TYR
	      {  0.04, -0.13,  0.00,  0.11,  0.24,  0.02, -0.04, -0.06,  0.09,  0.14,  0.13,  0.09, -0.20, -0.20, -0.10,  0.00, -0.34, -0.25, -0.21, -0.33 },
	      // ALA
	      {  0.00,  0.25,  0.03, -0.22, -0.01, -0.10, -0.09,  0.09, -0.13, -0.07, -0.09, -0.06,  0.08,  0.28,  0.26,  0.12,  0.34,  0.43,  0.14,  0.10 },
	      // GLY
	      { -0.08,  0.19,  0.38,  0.25,  0.23,  0.16,  0.18,  0.14, -0.07, -0.38, -0.26, -0.16, -0.06, -0.14,  0.25, -0.22,  0.20, -0.04,  0.11, -0.11 },
	      // THR
	      {  0.19,  0.19,  0.31,  0.14,  0.20,  0.25,  0.22,  0.13, -0.09, -0.26,  0.03, -0.08, -0.14, -0.11,  0.00, -0.29, -0.19, -0.35, -0.09, -0.07 },
	      // SER
	      { -0.02,  0.14,  0.29,  0.21,  0.25,  0.18,  0.34,  0.09, -0.06, -0.16, -0.08, -0.20, -0.14, -0.14, -0.26, -0.31, -0.05,  0.17, -0.13,  0.01 },
	      // GLN
	      {  0.05,  0.46,  0.49,  0.36,  0.26,  0.24,  0.08, -0.20,  0.08, -0.06, -0.14, -0.14,  0.29, -0.25, -0.17, -0.17, -0.02, -0.52, -0.38, -0.42 },
	      // ASN
	      {  0.13,  0.08,  0.18,  0.53,  0.30,  0.50,  0.06, -0.20,  0.28, -0.14, -0.11, -0.14, -0.25, -0.53, -0.32, -0.30, -0.24, -0.14, -0.33, -0.18 },
	      // GLU
	      {  0.69,  0.44,  0.27,  0.35,  0.43,  0.34,  0.29, -0.10,  0.26,  0.25,  0.00, -0.26, -0.17, -0.32, -0.03, -0.15, -0.45, -0.74, -0.97, -0.10 },
	      // ASP
	      {  0.03,  0.65,  0.39,  0.59,  0.67,  0.58,  0.24,  0.00,  0.12, -0.22, -0.29, -0.31, -0.17, -0.30, -0.15,  0.04, -0.39, -0.72, -0.76,  0.04 },
	      // HIS
	      { -0.19,  0.99, -0.16,  0.49,  0.16,  0.19, -0.12, -0.34,  0.34,  0.20, -0.19, -0.05, -0.02, -0.24, -0.45, -0.39, -0.29, -0.12,  0.22, -0.21 },
	      // ARG
	      {  0.24,  0.31,  0.41,  0.42,  0.35,  0.30, -0.16, -0.25,  0.43, -0.04, -0.35,  0.17, -0.52, -0.14, -0.74, -0.72, -0.12,  0.11,  0.75, -0.38 },
	      // LYS
	      {  0.71,  0.00,  0.44,  0.36,  0.19,  0.44,  0.22, -0.21,  0.14,  0.11, -0.09, -0.13, -0.38, -0.33, -0.97, -0.76,  0.22,  0.75,  0.25,  0.11 },
	      // PRO
	      {  0.00, -0.34,  0.20,  0.25,  0.42,  0.09, -0.28, -0.33,  0.10, -0.11, -0.07,  0.01, -0.42, -0.18, -0.10,  0.04, -0.21, -0.38,  0.11,  0.26 }
      };
*/
